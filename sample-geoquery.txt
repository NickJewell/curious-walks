-- Nearest 20 rows to an input point (lat, lon) using PostGIS
-- Assumes places(lat double precision, lon double precision)

WITH params AS (
  SELECT
    51.320863::double precision AS q_lat,
    -0.138098::double precision AS q_lon
)
SELECT
  p.*,
  ST_Distance(
    ST_SetSRID(ST_MakePoint(p.lon, p.lat), 4326)::geography,
    ST_SetSRID(ST_MakePoint(params.q_lon, params.q_lat), 4326)::geography
  ) AS distance_m
FROM places p
CROSS JOIN params
WHERE p.lat IS NOT NULL AND p.lon IS NOT NULL
ORDER BY distance_m
LIMIT 20;


-- Using new location index on places table
-- Coordinates for Big Ben: Lon -0.1246, Lat 51.5007

select
  "name",
  "curio-id",
  -- Calculate distance in meters
  st_distance(
    location, 
    st_point(-0.1246, 51.5007)::geography
  ) as distance_meters
from places
-- The <-> operator finds the 'nearest neighbors' efficiently using the index
order by location <-> st_point(-0.1246, 51.5007)::geography
limit 5;